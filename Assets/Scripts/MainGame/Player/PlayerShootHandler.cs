using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Pool;
using Unity.CustomTool;

/// <summary>
/// 該類別負責處理玩家射擊
/// </summary>
public class PlayerShootHandler
{
    private PlayerController _playerController = null;
    /// <summary>
    /// 子彈物件池
    /// </summary>
    private ObjectPool<ProjectileBase> projectilePool = null;

    private AudioSource shootAudio = null;

    public PlayerShootHandler(PlayerController playerController)
    {
        this._playerController = playerController;
        Initialize();
    }

    public void Initialize()
    {
        //物件池初始化
        projectilePool = new ObjectPool<ProjectileBase>(//參數 : 1.創建物件時要做的事情 2.索取物件時要做的事 3.回收物件時要做的事 4.物件刪除時要做的事
            () =>
            {
                ProjectileBase projectile = GameObject.Instantiate(_playerController.PlayerCurrentProjectile.gameObject, _playerController.PlayerPos, Quaternion.identity).GetComponent<ProjectileBase>();
                projectile.recycle = (p) =>
                {
                    projectilePool.Release(p);
                };
                return projectile;
            },
            (projectile) =>
            {
                projectile.gameObject.SetActive(true);
                projectile.transform.position = _playerController.PlayerPos;
                //projectile.ExistTime = 1f;//設定投射物存在時間
                projectile.InitProperties();
            },
            (projectile) =>
            {
                projectile.gameObject.SetActive(false);
            },
            (projectile) =>
            {
                GameObject.Destroy(projectile.gameObject);
            }, true, 100, 10000 //預設Pool容量100，最大上限10000
        );

        //初始化音效
        shootAudio = UnityTool.FindChildGameObject(_playerController.PlayerTransform.gameObject, "PlayerShootAudio").
            GetComponent<AudioSource>();
        shootAudio.clip = (AudioClip)Resources.Load($"AudioClips/Projectiles/Audio_{_playerController.PlayerCurrentProjectile.name}");
    }

    public void Shoot()
    {
        shootAudio.PlayOneShot(shootAudio.clip);

        switch (_playerController.PlayerAttackMode)
        {
            case PlayerController.PlayerAttackModeEnum.projectile:
                Vector2 direction = _playerController.MousePos - _playerController.PlayerPos;
                for (int i = 0; i < _playerController.ProjectilesCount; i++)
                {
                    ProjectileBase projectile = projectilePool.Get();
                    projectile.SetMoveDir(direction);
                }
                break;
            case PlayerController.PlayerAttackModeEnum.ray:
                break;
            case PlayerController.PlayerAttackModeEnum.other:
                break;
        }
    }
}
